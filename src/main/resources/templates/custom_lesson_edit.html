<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Ch·ªânh s·ª≠a: ' + ${lesson.title}">Ch·ªânh s·ª≠a b√†i h·ªçc</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .content-area {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .vocab-list {
            display: grid;
            gap: 15px;
        }
        
        .vocab-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .vocab-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .vocab-info {
            flex: 1;
        }
        
        .vocab-word {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .vocab-meaning {
            color: #666;
            margin-bottom: 3px;
        }
        
        .vocab-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .badge-system {
            background: #3498db;
            color: white;
        }
        
        .badge-user {
            background: #e74c3c;
            color: white;
        }
        
        .vocab-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-edit-vocab {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-edit-vocab:hover {
            background: #e67e22;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            min-width: 300px;
        }
        
        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid #27ae60;
        }
        
        .toast.error {
            border-left: 4px solid #e74c3c;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-message {
            flex: 1;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 th:text="'Ch·ªânh s·ª≠a: ' + ${lesson.title}">Ch·ªânh s·ª≠a b√†i h·ªçc</h1>
            <p th:text="${lesson.description}"></p>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showAddModal()">‚ûï Th√™m t·ª´ m·ªõi</button>
                <a th:href="@{/custom-lessons/{id}/view(id=${lesson.id})}" class="btn btn-secondary">üëÅÔ∏è Xem b√†i h·ªçc</a>
                <a th:href="@{/custom-lessons}" class="btn btn-secondary">‚¨ÖÔ∏è Quay l·∫°i</a>
            </div>
        </div>
        
        <div class="content-area">
            <h2 style="margin-bottom: 20px; color: #333;">
                Danh s√°ch t·ª´ v·ª±ng (<span th:text="${vocabularies.size()}">0</span> t·ª´)
            </h2>
            
            <div class="vocab-list" th:if="${vocabularies.size() > 0}">
                <div class="vocab-item" th:each="vocab : ${vocabularies}">
                    <div class="vocab-info">
                        <div class="vocab-word">
                            <span th:text="${vocab.word}">ËØç</span>
                            <span class="vocab-badge" 
                                  th:classappend="${vocab.isUserVocab} ? 'badge-user' : 'badge-system'"
                                  th:text="${vocab.isUserVocab} ? 'T·ª´ c·ªßa t√¥i' : 'T·ª´ h·ªá th·ªëng'">
                            </span>
                        </div>
                        <div class="vocab-meaning" th:text="${vocab.pronunciation}">pinyin</div>
                        <div class="vocab-meaning" th:text="${vocab.meaning}">meaning</div>
                    </div>
                    <div class="vocab-actions">
                        <button class="btn-edit-vocab" 
                                onclick="showEditModal(this)"
                                th:data-id="${vocab.id}"
                                th:data-word="${vocab.word}"
                                th:data-pronunciation="${vocab.pronunciation}"
                                th:data-pos="${vocab.pos}"
                                th:data-meaning="${vocab.meaning}"
                                th:data-example-src="${vocab.exampleSrc}"
                                th:data-example-vi="${vocab.exampleVi}"
                                th:data-level="${vocab.level}"
                                th:data-is-user-vocab="${vocab.isUserVocab}">
                            ‚úèÔ∏è S·ª≠a
                        </button>
                        <button class="btn-delete" 
                                onclick="deleteVocab(this)"
                                th:data-id="${vocab.id}"
                                th:data-is-user-vocab="${vocab.isUserVocab}"
                                th:data-word="${vocab.word}">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="empty-state" th:if="${vocabularies.size() == 0}">
                <h2>üìù Ch∆∞a c√≥ t·ª´ n√†o</h2>
                <p>H√£y th√™m t·ª´ v√†o b√†i h·ªçc c·ªßa b·∫°n!</p>
            </div>
        </div>
    </div>
    
    <!-- Modal th√™m t·ª´ m·ªõi -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Th√™m t·ª´ m·ªõi</h2>
            </div>
            <form id="addForm" onsubmit="addVocab(event)">
                <div class="form-group">
                    <label>T·ª´ v·ª±ng <span style="color: red;">*</span></label>
                    <input type="text" id="addWord" required>
                </div>
                <div class="form-group">
                    <label>Phi√™n √¢m</label>
                    <input type="text" id="addPronunciation">
                </div>
                <div class="form-group">
                    <label>T·ª´ lo·∫°i</label>
                    <input type="text" id="addPos" placeholder="n., v., adj., ...">
                </div>
                <div class="form-group">
                    <label>Nghƒ©a</label>
                    <textarea id="addMeaning" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>V√≠ d·ª• (ti·∫øng Trung)</label>
                    <textarea id="addExampleSrc" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>V√≠ d·ª• (ti·∫øng Vi·ªát)</label>
                    <textarea id="addExampleVi" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>C·∫•p ƒë·ªô</label>
                    <input type="text" id="addLevel" value="A1">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Th√™m</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addModal')">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal s·ª≠a t·ª´ -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Ch·ªânh s·ª≠a t·ª´ v·ª±ng</h2>
            </div>
            <form id="editForm" onsubmit="updateVocab(event)">
                <input type="hidden" id="editVocabId">
                <div class="form-group">
                    <label>T·ª´ v·ª±ng <span style="color: red;">*</span></label>
                    <input type="text" id="editWord" required>
                </div>
                <div class="form-group">
                    <label>Phi√™n √¢m</label>
                    <input type="text" id="editPronunciation">
                </div>
                <div class="form-group">
                    <label>T·ª´ lo·∫°i</label>
                    <input type="text" id="editPos">
                </div>
                <div class="form-group">
                    <label>Nghƒ©a</label>
                    <textarea id="editMeaning" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>V√≠ d·ª• (ti·∫øng Trung)</label>
                    <textarea id="editExampleSrc" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>V√≠ d·ª• (ti·∫øng Vi·ªát)</label>
                    <textarea id="editExampleVi" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>C·∫•p ƒë·ªô</label>
                    <input type="text" id="editLevel">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast">
        <div class="toast-icon" id="toastIcon">‚úÖ</div>
        <div class="toast-message" id="toastMessage"></div>
    </div>
    
    <script th:inline="javascript">
        const lessonId = /*[[${lesson.id}]]*/ 0;
        const languageCode = /*[[${lesson.languageCode}]]*/ 'cn';
        
        function showAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('addForm').reset();
        }
        
        function showEditModal(button) {
            const id = button.getAttribute('data-id');
            const word = button.getAttribute('data-word') || '';
            const pronunciation = button.getAttribute('data-pronunciation') || '';
            const pos = button.getAttribute('data-pos') || '';
            const meaning = button.getAttribute('data-meaning') || '';
            const exampleSrc = button.getAttribute('data-example-src') || '';
            const exampleVi = button.getAttribute('data-example-vi') || '';
            const level = button.getAttribute('data-level') || '';
            const isUserVocab = button.getAttribute('data-is-user-vocab') === 'true';
            
            document.getElementById('editVocabId').value = id;
            document.getElementById('editWord').value = word;
            document.getElementById('editPronunciation').value = pronunciation;
            document.getElementById('editPos').value = pos;
            document.getElementById('editMeaning').value = meaning;
            document.getElementById('editExampleSrc').value = exampleSrc;
            document.getElementById('editExampleVi').value = exampleVi;
            document.getElementById('editLevel').value = level;
            
            // Store isUserVocab in hidden field
            const form = document.getElementById('editForm');
            let isUserVocabField = document.getElementById('editIsUserVocab');
            if (!isUserVocabField) {
                isUserVocabField = document.createElement('input');
                isUserVocabField.type = 'hidden';
                isUserVocabField.id = 'editIsUserVocab';
                form.appendChild(isUserVocabField);
            }
            isUserVocabField.value = isUserVocab;
            
            // Disable/enable fields based on vocab type
            const isSystemVocab = !isUserVocab;
            document.getElementById('editWord').disabled = isSystemVocab;
            document.getElementById('editPronunciation').disabled = isSystemVocab;
            document.getElementById('editPos').disabled = isSystemVocab;
            document.getElementById('editMeaning').disabled = isSystemVocab;
            document.getElementById('editLevel').disabled = isSystemVocab;
            
            // Update modal title
            const modalTitle = document.querySelector('#editModal .modal-header h2');
            if (isSystemVocab) {
                modalTitle.innerHTML = 'üëÅÔ∏è Xem t·ª´ v·ª±ng h·ªá th·ªëng <small style="color: #e74c3c; font-size: 14px;">(Ch·ªâ c√≥ th·ªÉ s·ª≠a v√≠ d·ª•)</small>';
            } else {
                modalTitle.innerHTML = '‚úèÔ∏è Ch·ªânh s·ª≠a t·ª´ v·ª±ng';
            }
            
            // Update button text
            const submitBtn = document.querySelector('#editForm button[type="submit"]');
            submitBtn.textContent = isSystemVocab ? 'C·∫≠p nh·∫≠t v√≠ d·ª•' : 'C·∫≠p nh·∫≠t';
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            toast.className = 'toast show ' + type;
            icon.textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            msg.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        async function addVocab(event) {
            event.preventDefault();
            
            const formData = new URLSearchParams();
            formData.append('word', document.getElementById('addWord').value);
            formData.append('pronunciation', document.getElementById('addPronunciation').value);
            formData.append('pos', document.getElementById('addPos').value);
            formData.append('meaning', document.getElementById('addMeaning').value);
            formData.append('exampleSrc', document.getElementById('addExampleSrc').value);
            formData.append('exampleVi', document.getElementById('addExampleVi').value);
            formData.append('languageCode', languageCode);
            formData.append('level', document.getElementById('addLevel').value);
            
            try {
                const response = await fetch(`/custom-lessons/${lessonId}/vocabulary/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal('addModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                showToast('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }
        
        async function updateVocab(event) {
            event.preventDefault();
            
            const vocabId = document.getElementById('editVocabId').value;
            const isUserVocab = document.getElementById('editIsUserVocab').value === 'true';
            
            if (!isUserVocab) {
                showToast('Kh√¥ng th·ªÉ s·ª≠a t·ª´ h·ªá th·ªëng. Ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t v√≠ d·ª•.', 'error');
                return;
            }
            
            const formData = new URLSearchParams();
            formData.append('word', document.getElementById('editWord').value);
            formData.append('pronunciation', document.getElementById('editPronunciation').value);
            formData.append('pos', document.getElementById('editPos').value);
            formData.append('meaning', document.getElementById('editMeaning').value);
            formData.append('exampleSrc', document.getElementById('editExampleSrc').value);
            formData.append('exampleVi', document.getElementById('editExampleVi').value);
            formData.append('level', document.getElementById('editLevel').value);
            
            try {
                const response = await fetch(`/custom-lessons/${lessonId}/vocabulary/${vocabId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    closeModal('editModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                showToast('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }
        
        async function deleteVocab(button) {
            const vocabId = button.getAttribute('data-id');
            const isUserVocab = button.getAttribute('data-is-user-vocab') === 'true';
            const word = button.getAttribute('data-word');
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·ª´ "${word}" kh·ªèi b√†i h·ªçc?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/custom-lessons/${lessonId}/vocabulary/${vocabId}?isUserVocab=${isUserVocab}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                showToast('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }
        
        // Hi·ªÉn th·ªã flash message n·∫øu c√≥
        window.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra flash message t·ª´ server
            const flashSuccess = /*[[${success}]]*/ null;
            if (flashSuccess) {
                showToast(flashSuccess, 'success');
            }
            
            // Ki·ªÉm tra URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            if (success) {
                showToast(success, 'success');
            }
        });
    </script>
</body>
</html>
